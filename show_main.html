<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> Smart Home </title>
</head>

<body>
    <table style="height: 100%;width:1000px" align="center" border="1" cellspacing="0">
        <tr>
            <th width="500" valign="top">
                <h1>Smart Home Project</h1>
                <h3>Creator: Alexey Khromov ; Supervisor: Oren Kalinsky</h3>
                <br>
                Please look straight at the camera to be recognized.<br>
                Note: on first use, please push "new user" button.<br>
                After you've been recognized, use hand gestures:<br>
                - Up and down to scroll between posts<br>
                - Left and right to swipe between liked pages<br>
                <br>

                If it is your first use, please insert your unique username (NOT the ordinary name) as appear in Facebook and press "new user" button:
                <input id="new_user_input" placeholder="james.bond"/>
                <button id="new_user_button" onclick="new_user()" disabled>new user</button>
                <button id="clear_collection_button" onclick="clear_col()">clear all users</button>
                <br><br>

                Recognized person: <span id="person_name_span"></span><br>
                Now showing page: <span id="page_name_span"></span><br>
                Status: <span id="status_span"></span><br>
                <br><br>

                <video id="screenshot-video" autoplay width="320" height="240"></video><br>
                <canvas id="screenshot-canvas" style="display:none;"></canvas>
                <img id="screenshot-img" src="" hidden="hidden">
            </th>
            <th width="500">
                <div id="fb-root"></div>
                <!-- note 500px is max width of fb plugin-->
                    <div class="fb-post"
                          data-href=""
                          data-width="500"></div>
            </th>
        </tr>
    </table>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="opencv.js" type="text/javascript"></script>
    <script>

        // ----------------------------------------------------------------------------------------
        // Constants ------------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        const constraints = {video: true};
        const img = document.querySelector('#screenshot-img');
        const video = document.querySelector('#screenshot-video');
        const canvas = document.querySelector('#screenshot-canvas');

        // ----------------------------------------------------------------------------------------
        // Facebook Plugin ------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s);
            js.id = id;
            js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.1&appId=1721853424592137&autoLogAppEvents=1';
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // ----------------------------------------------------------------------------------------
        // Update FB page and status --------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function get_next_post() {
            //document.getElementById("status_span").textContent = 'interpreting photo';
            ready_to_continue = false;
            $.getJSON(
                {
                    url: "/interpretPhoto",
                    data: {'image_src': document.getElementById('screenshot-img').src},
                    success: function (result) {
                        if (result.status != '') {
                            $(".fb-post").attr('data-href', result.next_url);

                            if (result.status == "new_post") {
                                document.getElementById("status_span").textContent = result.gesture;
                            }
                            else if (result.status == "new_page") {
                                document.getElementById("page_name_span").textContent = result.page_name;
                                document.getElementById("status_span").textContent = result.gesture;
                            }
                            else if (result.status == "new_person") {
                                document.getElementById("status_span").textContent = '-';
                                document.getElementById("person_name_span").textContent = result.person_name;
                                document.getElementById("page_name_span").textContent = result.page_name;
                            }
                            else {
                                window.alert('Unrecognized returned status: ' + result.status);
                                document.getElementById("status_span").textContent = '-';
                                document.getElementById("person_name_span").textContent = '-';
                                document.getElementById("page_name_span").textContent = '-';
                            }

                            FB.XFBML.parse();
                        }
                        else {
                            document.getElementById("status_span").textContent = '-';
                        }
                        setTimeout( function() {}, 2000);
                        ready_to_continue = true;
                    },
                    error: function (result) {
                        ready_to_continue = true;
                    }
                });
        }

        // ----------------------------------------------------------------------------------------
        // Clear Collection -----------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function clear_col() {
            document.getElementById("status_span").textContent = 'clearing users'
            ready_to_continue = false;
            document.getElementById("new_user_button").disabled = true;
            $.getJSON(
                {
                    url: "/clrCol",
                    data: {},
                    success: function (result) {
                        if (result.status == 'collection cleared') {
                            window.alert(result.status);
                        } else {
                            window.alert('error in clearing');
                        }
                        setTimeout( function() {}, 2000);
                        ready_to_continue = true;
                        document.getElementById("new_user_button").disabled = false;
                         document.getElementById("status_span").textContent = ''
                    },
                    error: function (result) {
                        ready_to_continue = true;
                        document.getElementById("new_user_button").disabled = false;
                        document.getElementById("status_span").textContent = ''
                    }
                });
        }

        // ----------------------------------------------------------------------------------------
        // New User -------------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function new_user() {
            document.getElementById("status_span").textContent = 'adding user to system'
            ready_to_continue = false;
            document.getElementById("new_user_button").disabled = true;

            $.getJSON(
                {
                    url: "/newUser",
                    data: {'image_src': document.getElementById('screenshot-img').src,
                           'user_name': document.getElementById('new_user_input').value},
                    success: function (result) {
                        if (result.status != '') {
                            $(".fb-post").attr('data-href', result.next_url);
                            if (result.status == "new_person") {
                                document.getElementById("status_span").textContent = '-';
                                document.getElementById("person_name_span").textContent = result.person_name;
                                document.getElementById("page_name_span").textContent = result.page_name;
                            }
                            else {
                                window.alert('Unrecognized returned status: ' + result.status);
                                document.getElementById("status_span").textContent = '-';
                                document.getElementById("person_name_span").textContent = '-';
                                document.getElementById("page_name_span").textContent = '-';
                            }

                            FB.XFBML.parse();
                        }
                        else {
                            document.getElementById("status_span").textContent = '-';
                        }
                        setTimeout( function() {}, 2000);
                        ready_to_continue = true;
                        document.getElementById("new_user_button").disabled = false;
                    },
                  error: function (result) {
                        ready_to_continue = true;
                        document.getElementById("new_user_button").disabled = false;
                    }
                });
        }

        // ----------------------------------------------------------------------------------------
        // Camera Streaming  ----------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
        function handleSuccess(stream) {
            video.srcObject = stream;
        }
        function handleError(error) {
            console.error('Error: ', error);
        }

        // ----------------------------------------------------------------------------------------
        // Screenshot  ----------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function get_screenshot()
        {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            img.src = canvas.toDataURL('image/jpeg');
        }

        // ----------------------------------------------------------------------------------------
        // Infinite timer to update page and current user  ----------------------------------------
        // ----------------------------------------------------------------------------------------

        var interval = 250; // miliseconds
        var first_cycles_run_counter = 0;
        var ready_to_continue = true;

        function run_with_timer()
        {
            if (ready_to_continue) {
                get_screenshot();
                if (first_cycles_run_counter > 5) {
                    document.getElementById("new_user_button").disabled = false;
                    get_next_post();
                } else {
                    first_cycles_run_counter++; // async - takes time for first picture to be uploaded
                }
            }
            setTimeout(run_with_timer, interval);
        }

        $(document).ready(run_with_timer());
    </script>
</body>
</html>
