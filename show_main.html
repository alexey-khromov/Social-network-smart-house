<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> Smart Home </title>
</head>

<body>
    <table style="height: 100%;width:1000px" align="center" border="1" cellspacing="0">
        <tr>
            <th width="500" valign="top">
                <h1>Smart Home Project</h1>
                <h3>Creator: Alexey Khromov ; Supervisor: Oren Kalinsky</h3>
                <br>
                Please look straight at the camera to be recognized.<br>
                Note: you must be friend with Smart Home on Facebook to use the application.<br>
                After you've been recognized, use hand gestures:<br>
                - Up and down to scroll<br>
                - Left and right to swipe between liked pages.<br>
                <br><br>

                Status: <span id="status_span"></span><br>
                Recognized person: <span id="person_name_span"></span><br>
                Now showing page: <span id="page_name_span"></span><br>
                Recognized gesture: <span id="gesture_span"></span><br>
                <br><br>

                <video id="screenshot-video" autoplay width="450" height="450"></video><br>
                <canvas id="screenshot-canvas" style="display:none;"></canvas>
                <img id="screenshot-img" src="" hidden="hidden"><br>

            </th>
            <th width="500">
                <div id="fb-root"></div>
                <!-- note 500px is max width of fb plugin-->
                <div class="fb-page" style="height: 1000px; width: 500px;" data-href=""
                     data-tabs="timeline" data-send="false" data-height="1000" data-width="500"
                     data-small-header="false" data-adapt-container-width="true"
                     data-hide-cover="false" data-show-facepile="true" id="my-fb-page"></div>
            </th>
        </tr>
    </table>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="opencv.js" type="text/javascript"></script>
    <script>

        // ----------------------------------------------------------------------------------------
        // Constants ------------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        const constraints = {video: true};
        const img = document.querySelector('#screenshot-img');
        const video = document.querySelector('#screenshot-video');
        const canvas = document.querySelector('#screenshot-canvas');

        // ----------------------------------------------------------------------------------------
        // Facebook Window ------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s);
            js.id = id;
            js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.1&appId=1721853424592137&autoLogAppEvents=1';
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // ----------------------------------------------------------------------------------------
        // Update FB page -------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function get_next_page(direction) {

            if (direction==='next') {
                url_func = "/getNextFrame";
            } else if (direction==='prev') {
                url_func = "/getPrevFrame";
            } else {
                url_func = "error_in_param"
            }

            $.getJSON(
                {
                    url: url_func,
                    data: {},
                    success: function (result) {
                        if (result.status == "new_fb_page") {
                            $(".fb-page").attr('data-href', result.next_url);
                            document.getElementById("page_name_span").textContent = result.page_name;
                            FB.XFBML.parse();
                        }
                    }
                });
        }

        // ----------------------------------------------------------------------------------------
        // Check current user  --------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function get_person_name() {
            $.getJSON(
                {
                    url: "/getPersonName",
                    data: {'image_src': document.getElementById('screenshot-img').src},
                    success: function (result) {
                        if (result.status === "recognizing") {
                            document.getElementById("status_span").textContent = 'Recognizing...';
                            document.getElementById("page_name_span").textContent = '-';
                        }
                        else if (result.status === "recognized") {
                            document.getElementById("status_span").textContent = 'Recognized.';
                        }
                        else if (result.status === "recognized_new") {
                            get_next_page('next');
                        }
                        document.getElementById("person_name_span").textContent = result.person_name;
                    }
                });
        }

        // ----------------------------------------------------------------------------------------
        // Check gesture  -------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function get_gesture() {
            $.getJSON(
                {
                    url: "/getHandGesture",
                    data: {'image_src': document.getElementById('screenshot-img').src},
                    success: function (result) {

                        var ges_name = result.gesture_name;
                        document.getElementById("status_span").textContent = ges_name;
                        if (ges_name === 'scroll_down') {
                            // TODO: fix - nothing works
                            FB.canvas.scrollTo(100, 100);
                            document.getElementById("my-fb-page").scrollTo(100, 100);
                        } else if (ges_name === 'scroll_up') {
                            // TODO: fix - nothing works
                            FB.canvas.scrollTo(-100, -100);
                            document.getElementById("my-fb-page").scrollTo(-100, -100);
                        } else if (ges_name === 'swipe_right') {
                            get_next_page('next');
                        } else if (ges_name === 'swipe_left') {
                            get_next_page('prev');
                        }
                    }
                });
        }

        // ----------------------------------------------------------------------------------------
        // Camera Functionns  ---------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
        function handleSuccess(stream) {
            video.srcObject = stream;
        }
        function handleError(error) {
            console.error('Error: ', error);
        }

        // ----------------------------------------------------------------------------------------
        // Screenshot  ----------------------------------------------------------------------------
        // ----------------------------------------------------------------------------------------

        function get_screenshot()
        {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            img.src = canvas.toDataURL('image/jpeg');
        }

        // ----------------------------------------------------------------------------------------
        // Infinite timer to update page and current user  ----------------------------------------
        // ----------------------------------------------------------------------------------------

        var interval = 250; // miliseconds
        var cycles_till_recognition = 5000 / interval; // we want recognition once in 5 seconds
        var calls_counter = 0;
        var first_cycles_run_counter = 0;

        function run_with_timer() {

            if (first_cycles_run_counter < 5) { // async - takes time for first picture to load
                first_cycles_run_counter++;
                get_screenshot();
            } else {
                get_screenshot();
                if (calls_counter === cycles_till_recognition - 1) {
                    get_person_name();
                    return;
                } else {
                    get_gesture();
                }
                calls_counter = (calls_counter + 1) % cycles_till_recognition;
            }

            setTimeout(run_with_timer, interval);
        }

        $(document).ready(run_with_timer());
    </script>
</body>
</html>
